pipeline {
    agent any

    environment {
        // MySQL credentials
        MYSQL_ROOT_PASSWORD = credentials('mysql-root-pass')
        MYSQL_USER          = credentials('mysql-user')
        // MYSQL_PASSWORD      = credentials('mysql-pass')

        // Spring Boot DB credentials
        SPRING_DATASOURCE_USERNAME = credentials('spring-db-user')
        SPRING_DATASOURCE_PASSWORD = credentials('spring-db-pass')
        SPRING_DATASOURCE_URL      = "jdbc:mysql://mysql-db:3306/expense_tracker"

        // AI API
        DEEPSEEK_API_KEY = credentials('deepseek-key')
        DEEPSEEK_API_URL = credentials('deepseek-url')
    }

    stages {
        stage('Set Build Name') {
            steps {
                script {
                    // Use branch name + date-time as build display name
                    def branch = env.BRANCH_NAME ?: "main"
                    def now = new Date().format("yyyy-MM-dd_HH-mm-ss")
                    currentBuild.displayName = "${branch}-${now}"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Deploy') {
            steps {
                sh '''
                echo "ðŸ”¹ Starting Docker Compose build & deploy"
                docker compose up --build -d
                '''
            }
        }
    }
}
